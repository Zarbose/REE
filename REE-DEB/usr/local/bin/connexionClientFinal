#!/bin/bash

while [ -z "$(ifconfig eth0 | grep 'inet ')" ]
do
    sleep 1
done

systemctl stop hostapd.service

ipwlan1=$(ifconfig wlan1 | grep 'inet ' | awk '{print $2}')

iprouter=$(echo "$ipwlan1" | awk -F'.' '{print $1"."$2"."$3 "."1}')

echo "interface eth0
static ip_address=192.168.0.0/24
static routers=$iprouter
static domain_name_servers=8.8.8.8
" >> /etc/dhcpcd.conf


echo "interface=eth0
dhcp-range=192.168.0.2,192.168.0.253,255.255.255.0,24h
server=8.8.8.8" >> /etc/dnsmasq.conf


systemctl restart dhcpcd.service
systemctl restart dnsmasq.service

echo " " > /etc/iptables/rules.v4
iptables -F
iptables -t nat -F
iptables -P INPUT ACCEPT
iptables -P FORWARD ACCEPT
iptables -P OUTPUT ACCEPT
iptables -A FORWARD -i wlan1 -o eth0 -j ACCEPT
iptables -A FORWARD -i eth0 -o wlan1 -j ACCEPT
iptables -t nat -A POSTROUTING -o wlan1 -j MASQUERADE
sh -c "iptables-save > /etc/iptables/rules.v4"

sudo systemctl restart delroute.

touch /home/rpi/preuve


exit 0