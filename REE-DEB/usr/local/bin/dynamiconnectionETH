#!/bin/bash

LOG_FILE="/var/log/REE.log"
log() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" >> "$LOG_FILE"
}

# Raspberry numéro 1.
log "Début du protocole de configuration de la Raspberry numéros 1"

# Configuration inteface wlan0 
total_lignes=$(wc -l < /etc/dhcpcd.conf | awk '{print $1}')
head -n $((total_lignes - 5)) /etc/dhcpcd.conf > fichier_temporaire.txt
mv fichier_temporaire.txt /etc/dhcpcd.conf

echo -n 'interface wlan0
static ip_address=10.0.1.1/29
#IP DE la box
static routers=192.168.1.254
static domain_name_servers=8.8.8.8
' >> /etc/dhcpcd.conf

systemctl restart dhcpcd.service

# Configuration DNSmasq
echo 'interface=wlan0
dhcp-range=10.0.1.2,10.0.1.3,255.255.255.248,24h
server=8.8.8.8
' > /etc/dnsmasq.conf

systemctl restart dnsmasq.service

log "DNSmasq restart ... "

#clean /etc/iptables/rules.v4
echo " " > /etc/iptables/rules.v4

# Finalisation de la configuration IPtable
iptables -F
iptables -t nat -F
iptables -P INPUT ACCEPT
iptables -P FORWARD ACCEPT
iptables -P OUTPUT ACCEPT
iptables -A FORWARD -i wlan0 -o eth0 -j ACCEPT
iptables -A FORWARD -i eth0 -o wlan0 -j ACCEPT
iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
sh -c "iptables-save > /etc/iptables/rules.v4" 

log "Ecriture des iptables."

log "Restart hostapd"
systemctl restart hostapd.service

log "Activation IP forward"
echo 1 > /proc/sys/net/ipv4/ip_forward
