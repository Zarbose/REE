#!/bin/bash

LOG_FILE="/var/log/REE.log"

# Fonction pour ajouter un timestamp aux messages de logs
log() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" >> "$LOG_FILE"
}

# Raspberry numéro N.
log "Raspberry numero N."

# Obtension de l'adresse IP de l'interface wlan1 (obtenue via DHCP de la Pi précédente)
ipwlan1=$(ifconfig wlan1 | grep 'inet ' | awk '{print $2}')

# Deduction de ipwlan0 grâce à wlan1
# ipwlan1=10.0.N.2
# ipwlan0=10.0.N+1.1
ipwlan0=$(echo "$ipwlan1" | awk -F'.' '{print $1"."$2"."$3 + 1 "."$4 - 1}')
log "ipwlan0 = $ipwlan0"

# Deduction ipdhcp grâce a wlan0
ipdhcp=$(echo "$ipwlan0" | awk -F'.' '{print $1"."$2"."$3"."$4 +1 }')
log "ipdhcp = $ipdhcp"

# Deduction de iprouter grâce à wlan1
iprouter=$(echo "$ipwlan1" | awk -F'.' '{print $1"."$2"."$3 "."$4 - 1}')
log "iprouter = $iprouter"

# Modification IP inteface wlan0 
total_lignes=$(wc -l < /etc/dhcpcd.conf | awk '{print $1}')
head -n $((total_lignes - 5)) /etc/dhcpcd.conf > fichier_temporaire.txt
mv fichier_temporaire.txt /etc/dhcpcd.conf

echo "interface wlan0
static ip_address=$ipwlan0/29
#IP DE la box
static routers=$iprouter
static domain_name_servers=8.8.8.8
" >> /etc/dhcpcd.conf

systemctl restart dhcpcd.service

log "Modification et Restart de dhcpcd"

# Modification IP DNSmasq

echo "interface=wlan0
dhcp-range=$ipwlan0,$ipdhcp,255.255.255.248,24h
server=8.8.8.8" > /etc/dnsmasq.conf

systemctl restart dnsmasq.service
log "Modification et Restart de dnsmasq"


#clean /etc/iptables/rules.v4
echo " " > /etc/iptables/rules.v4

# Finalisation de la configuration IPtable
iptables -F
iptables -t nat -F
iptables -P INPUT ACCEPT
iptables -P FORWARD ACCEPT
iptables -P OUTPUT ACCEPT
iptables -A FORWARD -i wlan0 -j ACCEPT
iptables -A FORWARD -o wlan0 -j ACCEPT
iptables -t nat -A POSTROUTING -o wlan1 -j MASQUERADE

iptables-save | sudo tee /etc/iptables/rules.v4

log "Ecriture des iptables."

sysctl -w net.ipv4.ip_forward=1 
sysctl -p

chmod u+x /run/hostpad.pid
chmod g+x /run/hostpad.pid
chmod o+x /run/hostpad.pid

log "Restart hostapd"
systemctl restart hostapd.service

#ip route flush table main
# sudo ip route del default via $iprouter dev wlan0 src $ipwlan0 metric 303
# sudo ip route del $iprouter dev wlan0 scope link src $ipwlan0 metric 303
# log "Cleaning des routes existantes."

# Ajouter la route souhaitée
# ip route add -net $ipwlan1 netmask 255.255.255.248 dev wlan0
# ip route add default via $iprouter dev wlan1

#log "ajout de la route wlan0 vers $ipwlan1 ."