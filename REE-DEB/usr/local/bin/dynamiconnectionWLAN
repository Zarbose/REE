#!/bin/bash

LOG_FILE="/var/log/REE.log"
log() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" >> "$LOG_FILE"
}

# Raspberry numéro N.
log "Début du protocole de configuration de la Raspberry numero N."

# Obtension de l'adresse IP de l'interface wlan1 (obtenue via DHCP de la Pi précédente)
ipwlan1=$(ifconfig wlan1 | grep 'inet ' | awk '{print $2}')
log "ipwlan1 = $ipwlan1"

# Calcul de ipwlan0 grâce à wlan1
ipwlan0=$(echo "$ipwlan1" | awk -F'.' '{print $1"."$2"."$3 + 1 "."1}')
log "ipwlan0 = $ipwlan0"

# Calcul ipdhcp grâce a wlan0
ipdhcp=$(echo "$ipwlan0" | awk -F'.' '{print $1"."$2"."$3"."$4 +1 }')
log "ipdhcp = $ipdhcp"

# Calcul ipdhcp2 grâce a ipdhcp
ipdhcp2=$(echo "$ipdhcp" | awk -F'.' '{print $1"."$2"."$3"."$4 +1 }')
log "ipdhcp2 = $ipdhcp2"

# Calcul de iprouter grâce à wlan1
iprouter=$(echo "$ipwlan1" | awk -F'.' '{print $1"."$2"."$3 "."1}')
log "iprouter = $iprouter"

# Modification IP inteface wlan0 pour dhcpcd
log "Modification de dhcpcd"
cat /usr/local/default/dhcpcd.conf > /etc/dhcpcd.conf
echo "interface wlan0
static ip_address=$ipwlan0/29
#IP DE la box
static routers=$iprouter
static domain_name_servers=8.8.8.8
" >> /etc/dhcpcd.conf

# Modification IP DNSmasq
log "Modification de dnsmasq"
echo "interface=wlan0
dhcp-range=$ipdhcp,$ipdhcp2,255.255.255.248,24h
server=8.8.8.8" > /etc/dnsmasq.conf


log "Ecriture des iptables."
echo " " > /etc/iptables/rules.v4
# Finalisation de la configuration IPtable
iptables -F
iptables -t nat -F
iptables -P INPUT ACCEPT
iptables -P FORWARD ACCEPT
iptables -P OUTPUT ACCEPT
iptables -A FORWARD -i wlan0 -j ACCEPT
iptables -A FORWARD -o wlan0 -j ACCEPT
iptables -t nat -A POSTROUTING -o wlan1 -j MASQUERADE
iptables-save | sudo tee /etc/iptables/rules.v4

chmod u+x /run/hostpad.pid
chmod g+x /run/hostpad.pid
chmod o+x /run/hostpad.pid


# Clean
log "Nettoyage interface avant restart"
sudo systemctl stop dhcpcd.service
sudo systemctl stop dnsmasq.service
sudo systemctl stop hostapd.service

sudo ifconfig wlan0 down
sudo ifconfig wlan1 down

sudo ip addr flush dev wlan0
sudo ip addr flush dev wlan1

systemctl stop wpa_supplicant@wlan1.service
systemctl start wpa_supplicant@wlan1.service


# Restart
log "Restart de dhcpcd + dnsmasq + hostapd"
systemctl restart dhcpcd.service
systemctl restart dnsmasq.service
systemctl restart hostapd.service


sleep 5
while [ $(ifconfig wlan1 | grep 'inet ' | awk '{print $2}' | wc -w) -eq 0 ]
do
    dhclient
    sleep 2
done