#!/bin/bash

LOG_FILE="/var/log/REE.log"

log() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" >> "$LOG_FILE"
}

log "Nettoyage"
## Rétablissement des paramètres par défaut
systemctl stop wpa_supplicant@wlan1.service
systemctl stop hostapd.service
systemctl stop dnsmasq.service
systemctl stop dhcpcd.service

cat /usr/local/default/wpa_supplicant-wlan1.conf > /etc/wpa_supplicant/wpa_supplicant-wlan1.conf
cat /usr/local/default/hostapd.conf > /etc/hostapd/hostapd.conf
cat /usr/local/default/dhcpcd.conf > /etc/dhcpcd.conf
cat /usr/local/default/dnsmasq.conf > /etc/dnsmasq.conf

# systemctl restart wpa_supplicant@wlan1.service
# systemctl restart hostapd.service
# systemctl restart dnsmasq.service
# systemctl restart dhcpcd.service

dhclient -r wlan1
dhclient -r wlan0

sudo ifconfig wlan0 down
sudo ifconfig wlan1 down

sudo ip addr flush dev wlan0
sudo ip addr flush dev wlan1

# Recherche du réseau REE
systemctl start wpa_supplicant@wlan1.service


# Activation IP forward
log "Activation IP forward"
echo 1 > /proc/sys/net/ipv4/ip_forward


log "Attente d'une ip sur eth0 ou wlan1"
## Attente que l'une des interfaces (eth0 ou wlan1) obtienne une adresse IP
while ! (ifconfig eth0 | grep -q 'inet ' || (ifconfig wlan1 | grep -q 'inet ' && ifconfig wlan1 | grep -q 'inet 10.')); do
    sleep 1
done

log "Une des interfaces a obtenu une adresse IP."
if ifconfig eth0 | grep -q 'inet '; then # Raspberry numéro 1.
    log "Raspberry numéros 1 -> IP = $(ifconfig eth0 | grep 'inet ' | tr -s ' ' | awk '{print $2}')"

    echo "0" > /usr/local/vars/type

    systemctl start dynamicETH.service
else # Raspberry numéro N.
    log "Raspberry numero N."

    echo "1" > /usr/local/vars/type

    systemctl start dynamicWLAN.service
    systemctl start wifisignal.service
fi

